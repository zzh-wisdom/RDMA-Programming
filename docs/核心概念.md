# 核心概念

## Memory Registration(MR) | 内存注册

RDMA 就是用来对内存进行数据传输。那么怎样才能对内存进行传输，很简单，注册。 因为RDMA硬件对用来做数据传输的内存是有特殊要求的。

- 在数据传输过程中，应用程序**不能修改数据所在的内存**。
- 操作系统不能对数据所在的内存进行page out操作 – **物理地址和虚拟地址的映射必须是固定不变**的。
- 注意无论是DMA或者RDMA都要求物理地址连续，这是由DMA引擎所决定的。 

那么怎么进行内存注册呢？

- 创建两个key (local和remote)指向需要操作的内存区域
- 注册的keys是数据传输请求的一部分

注册一个Memory Region之后，这个时候这个Memory Region也就有了它自己的属性：

- context : RDMA操作上下文
- addr : MR被注册的Buffer地址
- length : MR被注册的Buffer长度
- lkey：MR被注册的本地key
- rkey：MR被注册的远程key

## Queues | 队列

- 发送队列(SQ)
- 接收队列(RQ)
- 完成队列(CQ)

> SQ和RQ通常成对创建，被称为Queue Pairs(QP)

DMA是基于消息的传输协议，数据传输都是异步操作。 RDMA操作其实很简单，可以理解为：

> 1. Host提交工作请求(WR)到工作队列(WQ): 工作队列包括发送队列(SQ)和接收队列(RQ)。工作队列的每一个元素叫做WQE, 也就是WR。
> 2. Host从完成队列(CQ）中获取工作完成(WC): 完成队列里的每一个叫做CQE, 也就是WC。
> 3. 具有RDMA引擎的硬件(hardware)就是一个队列元素处理器。 RDMA硬件不断地从工作队列(WQ)中去取工作请求(WR)来执行，执行完了就给完成队列(CQ)中放置工作完成(WC)。

从生产者-消费者的角度理解就是：

> Host生产WR, 把WR放到WQ中去
> RDMA硬件消费WR
> RDMA硬件生产WC, 把WC放到CQ中去
> Host消费WC

## 传输

RDMA共有三种底层数据传输模式。

1. SEND/RECEIVE是双边操作，即必须要远端的应用感知参与才能完成收发。
2. READ和WRITE是单边操作，只需要本端明确信息的源和目的地址，远端应用不必感知此次通信，数据的读或存都通过远端的DMA在RNIC与应用buffer之间完成，再由远端RNIC封装成消息返回到本端。
3. 在实际中，SEND/RECEIVE多用于连接控制类报文，而数据报文多是通过READ/WRITE来完成的。

### 双边

对于双边操作为例，A向B发送数据的流程如下：

1. 首先，A和B都要创建并初始化好各自的QP，CQ
2. A和B分别向自己的WQ中注册WQE，对于A，WQ=SQ，WQE描述指向一个等到被发送的数据；对于B，WQ=RQ，WQE描述指向一块用于存储数据的buffer。
3. A的RNIC异步调度轮到A的WQE，解析到这是一个SEND消息，从buffer中直接向B发出数据。数据流到达B的RNIC后，B的WQE被消耗，并把数据直接存储到WQE指向的存储位置。
4. AB通信完成后，A的CQ中会产生一个完成消息CQE表示发送完成。与此同时，B的CQ中也会产生一个完成消息表示接收完成。每个WQ中WQE的处理完成都会产生一个CQE。

### 单边

对于单边操作，以存储网络环境下的存储为例（A作为文件系统，B作为存储介质）：

1. 首先A、B建立连接，QP已经创建并且初始化。
2. 数据被存档在A的buffer地址VA，注意VA应该提前注册到A的RNIC，并拿到返回的local key，相当于RDMA操作这块buffer的权限。
3. A把数据地址VA，key封装到专用的报文传送到B，这相当于A把数据buffer的操作权交给了B。同时A在它的WQ中注册进一个WR，以用于接收数据传输的B返回的状态。
4. B在收到A的送过来的数据VA和R_key后，RNIC会把它们连同存储地址VB（VB应该也需要提前注册到B的RNIC）到封装RDMA READ，这个过程A、B两端不需要任何软件参与，就可以将A的数据存储到B的VB虚拟地址。
5. B在存储完成后，会向A返回整个数据传输的状态信息。

### RDMA 双边操作和单边操作的不同

RC:面向连接的可靠服务

UC:面向连接的不可靠服务

UD:面向数据报的不可靠服务

**面向连接 vs 面向数据报**

相同点：两者的通信均包括双方QP对的参与
不同点：面向连接的通信若有N个节点与之通信，本机需要N个QP对；

               面向数据报的通信可以做到N个节点与之通信，本机仅需一个QP队；

**one-sided RDMA VS two sided RDMA**

相同点：两者均绕过内核
不同点：**one-sided RDMA还绕过远端服务器的CPU**


